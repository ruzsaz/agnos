"use strict";var bar2panel=panel_bar2d;function panel_bar2d(c){var b=this;this.constructorName="panel_bar2d";this.defaultInit={group:0,position:undefined,dimx:0,dimy:1,val:0,multiplier:1,ratio:false,streched:false,domain:[],domainr:[]};this.actualInit=global.combineObjects(b.defaultInit,c);Panel.call(b,b.actualInit,global.mediators[b.actualInit.group],true,global.numberOffset,0);this.valToShow=b.actualInit.val;this.valFraction=b.actualInit.ratio;this.isStretched=b.actualInit.streched;this.dimXToShow=b.actualInit.dimx;this.dimYToShow=b.actualInit.dimy;this.valMultiplier=b.actualInit.multiplier;this.dimX=(b.dimXToShow<=b.dimYToShow)?0:1;this.dimY=(b.dimXToShow<b.dimYToShow)?1:0;this.preparedData;this.maxEntries=global.maxEntriesIn2D;this.maxEntries1D=global.maxEntriesIn1D;this.shadowTimeout;this.xScale=d3.scale.linear().range([0,b.width]);this.yScale=d3.scale.linear().range([b.height,0]).nice(10);d3.svg.axis().scale(b.xScale).orient("bottom");this.yAxis=d3.svg.axis().scale(b.yScale).orient("left").ticks(10).tickFormat(global.cleverRound3);if(b.isStretched){b.yAxis.scale(d3.scale.linear().range([b.height,0]).domain([0,1])).tickFormat(d3.format("%"))}b.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("click",function(){b.drill(b.dimX)}).on("mouseover",function(){b.hoverOn(this,0)}).on("mouseout",function(){b.hoverOff()}).append("svg:rect").attr("width",b.w).attr("height",b.height+b.margin.top);b.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("click",function(){b.drill(b.dimY)}).on("mouseover",function(){b.hoverOn(this,1)}).on("mouseout",function(){b.hoverOff()}).append("svg:rect").attr("width",b.w).attr("height",b.h-b.height-b.margin.top).attr("transform","translate(0, "+(b.height+b.margin.top)+")");this.gAxisXShadow=b.svg.insert("svg:g",".title_group").attr("class","axisX axis").attr("transform","translate("+b.margin.left+", "+b.margin.top+")");this.gBars=b.svg.insert("svg:g",".title_group").attr("class","bar_group").attr("transform","translate("+b.margin.left+", "+b.margin.top+")");this.gAxisX=b.svg.insert("svg:g",".title_group").attr("class","axisX axis noEvents").attr("transform","translate("+b.margin.left+", "+b.margin.top+")");b.gAxisX.append("svg:line").attr("x1",0).attr("y1",b.height).attr("x2",b.width).attr("y2",b.height);this.gAxisY=b.svg.insert("svg:g",".title_group").attr("class","axis axisY noEvents").attr("transform","translate("+b.margin.left+", "+b.margin.top+")");var a;a=b.mediator.subscribe("changeValue",function(f,e,d){b.doChangeValue(f,e,d)});b.mediatorIds.push({channel:"changeValue",id:a.id});a=b.mediator.subscribe("changeDimension",function(d,e,f){b.doChangeDimension(d,e,f)});b.mediatorIds.push({channel:"changeDimension",id:a.id});b.mediator.publish("register",b,b.panelId,[b.dimXToShow,b.dimYToShow],b.preUpdate,b.update,b.getConfig)}panel_bar2d.prototype=global.subclassOf(Panel);panel_bar2d.prototype.barPadding=0.1;panel_bar2d.prototype.xAxisTectColor=global.panelBackgroundColor;panel_bar2d.prototype.valueToShow=function(c){var a=this;if(c!==undefined&&c.vals!==undefined){var b=(a.valFraction)?a.valMultiplier*c.vals[a.valToShow].sz/c.vals[a.valToShow].n:c.vals[a.valToShow].sz;if(isNaN(parseInt(b))){b=0}return b}else{return null}};panel_bar2d.prototype.getTooltip=function(b,a){var c=this;return c.createTooltip([{name:c.meta.dimensions[c.dimXToShow].description,value:(b.name)?b.name:"Nincs adat"},{name:c.meta.dimensions[c.dimYToShow].description,value:(a.dimYName)?a.dimYName:"Nincs adat"}],[{name:c.meta.indicators[c.valToShow].description,value:a.value,dimension:((c.valFraction)?c.meta.indicators[c.valToShow].fraction.unit:c.meta.indicators[c.valToShow].value.unit)}])};panel_bar2d.prototype.getCmpFunction=function(){var a=this;return function(d,c){return(d.dims[a.dimX].name+":"+d.dims[a.dimY].name).localeCompare(c.dims[a.dimX].name+":"+c.dims[a.dimY].name)}};panel_bar2d.prototype.simpleCmp=function(d,c){return d.name.localeCompare(c.name)};panel_bar2d.prototype.setYScale=function(b){var a=(this.valFraction)?this.actualInit.domainr:this.actualInit.domain;if((a instanceof Array)&&a.length===2){this.yScale.domain(a)}else{this.yScale.domain(b)}if(!this.isStretched){this.yScale.nice(10)}};panel_bar2d.prototype.preUpdate=function(e){var g=this;var a=this.preparedData;if(e.dim===g.dimXToShow){if(e.direction===-1){g.gAxisX.selectAll("text").filter(function(j){return(j.id!==e.toId)}).remove();g.gAxisXShadow.selectAll("rect").on("click",null).remove();g.gBars.selectAll(".bar").filter(function(j){return(j.id!==e.toId)}).on("click",null).remove()}else{if(e.direction===1&&(g.dimXToShow!==g.dimYToShow)){g.gAxisX.selectAll("text").filter(function(j){return(j.id!==e.fromId)}).remove();g.gAxisXShadow.selectAll("rect").on("click",null).remove();var h=[];var b=(global.baseLevels[g.panelSide])[g.dimYToShow].length;for(var f=0,d=a.dimYArray.length;f<d;f++){var k=d3.mean(a.dataArray,function(j){return(j.values[f]===undefined)?undefined:j.values[f].height});var i=d3.mean(a.dataArray,function(j){return(j.values[f]===undefined)?undefined:j.values[f].y});h.push({dimYId:a.dimYArray[f].id,dimYUniqueId:b+"L"+a.dimYArray[f].id,height:k,y:i,startOpacity:1})}g.gBars.selectAll(".bar").on("click",null).remove();var c=(global.baseLevels[g.panelSide])[g.dimXToShow].length;g.gBars.selectAll(".bar").data([{id:e.fromId,uniqueId:c+"L"+e.fromId}]).enter().append("svg:g").attr("class","bar bordered darkenable").attr("transform","translate("+(g.xScale.range()[1]*(g.barPadding/2))+", 0)").selectAll("rect").data(h).enter().append("svg:rect").attr("x",0).attr("width",g.xScale.range()[1]*(1-g.barPadding)).attr("y",function(j){return j.y}).attr("height",function(j){return j.height}).attr("fill",function(j){return global.color(j.dimYId)}).attr("opacity",1)}}}else{if(e.dim===g.dimYToShow){if(e.direction===-1){g.gLegend.selectAll(".legendEntry").filter(function(j){return(j.id!==e.toId)}).on("click",null).on("mouseover",null).on("mouseout",null).remove();g.gBars.selectAll(".bar rect").filter(function(j){return(j.dimYId!==e.toId)}).remove()}else{if(e.direction===1){g.gLegend.selectAll(".legendEntry").on("mouseover",null).on("mouseout",null).on("click",null).remove();g.gLegend.selectAll("g").data([1]).enter().append("svg:g").append("svg:path").attr("d",global.rectanglePath(global.legendOffsetX,g.h-global.legendHeight-global.legendOffsetY,g.legendWidth,global.legendHeight,global.rectRounding,global.rectRounding,global.rectRounding,global.rectRounding)).attr("class","legend bordered darkenable").attr("fill",global.color(e.fromId))}}}}};panel_bar2d.prototype.prepareData=function(J,r,O){var H=this;var E=(global.baseLevels[H.panelSide])[H.dimXToShow].length;var D=(global.baseLevels[H.panelSide])[H.dimYToShow].length;r.sort(H.getCmpFunction());var P=[];var u=[];var l;var a=-1;for(var N=0;N<r.length;N++){var Q=r[N];if(Q.dims[H.dimX].id!==l){l=Q.dims[H.dimX].id;a++;var o={};o.index=a;o.id=l;o.uniqueId=E+"L"+o.id;o.name=Q.dims[H.dimX].name.trim();o.values=[];o.sumValues=0;u.push(o)}var s=Q.dims[H.dimY];var B=global.positionInArrayByProperty(P,"id",s.id);if(B===-1){B=P.length;var h={index:B,id:s.id,uniqueId:D+"L"+s.id,knownId:s.knownId,name:s.name.trim(),parentId:s.parentId,tooltip:"<html>"+s.name.trim()+"</html>"};P.push(h)}var o=u[u.length-1];var z=H.valueToShow(Q);o.values.push({index:B,value:z,dimYId:s.id,dimYUniqueId:D+"L"+s.id,dimYName:s.name.trim()});o.sumValues=o.sumValues+z}var b=(O.dim===H.dimXToShow&&O.direction===-1&&J!==undefined)?global.getFromArrayByProperty(J.dataArray,"id",O.toId):null;var x=(b)?b.x:0;var C=(O.dim===H.dimXToShow&&O.direction===1)?global.positionInArrayByProperty(u,"id",O.fromId):null;var L=H.xScale.range()[1];var t=L*(1-H.barPadding);var q=H.yScale.domain()[1];var A=d3.max(u,function(i){return i.sumValues});H.xScale.domain([0,u.length]);H.setYScale([0,A]);var y=((H.isStretched)?1:H.yScale.domain()[1]/q);var g=d3.scale.linear().domain([0,A]).range([0,A]);var K=H.xScale(1-H.barPadding);for(var N=0,m=u.length;N<m;N++){var o=u[N];var k=(J!==undefined)?global.getFromArrayByProperty(J.dataArray,"id",o.id):undefined;if(H.isStretched){g.domain([0,o.sumValues])}o.x=H.xScale(N+H.barPadding/2);o.width=K;if(O.dim===H.dimXToShow&&O.direction===-1&&b){o.oldX=x;o.oldWidth=(b.width/m);x=x+o.oldWidth}else{if(O.dim===H.dimXToShow&&O.direction===1){o.oldX=(N-C+H.barPadding/2)*L;o.oldWidth=t}else{o.oldX=o.x;o.oldWidth=o.width}}var R=o.values;var S=0;for(var M=0,G=R.length;M<G;M++){var Q=o.values[M];Q.height=H.yScale(g(0))-H.yScale(g(Q.value));Q.y=H.yScale(g(Q.value+S));Q.tooltip=H.getTooltip(o,Q);S=S+Q.value}if(O.dim===H.dimXToShow&&O.direction===-1&&b){for(var M=0,G=R.length;M<G;M++){var Q=o.values[M];Q.oldY=b.values[M].y;Q.oldHeight=b.values[M].height;Q.startOpacity=1}}else{if(O.dim===H.dimXToShow&&O.direction===1){for(var M=0,G=R.length;M<G;M++){var Q=o.values[M];Q.oldY=global.orZero(H.height*(1-y)+y*Q.y);Q.oldHeight=global.orZero(y*Q.height);Q.startOpacity=(N===C)?1:0}}else{if(O.dim===H.dimYToShow&&O.direction===-1&&k!==undefined){var f=global.getFromArrayByProperty(k.values,"dimYId",O.toId);var w=f.y+f.height;for(var M=0,G=R.length;M<G;M++){var Q=o.values[M];Q.oldHeight=f.height/G;w=w-Q.oldHeight;Q.oldY=w;Q.startOpacity=1}}else{if(O.dim===H.dimYToShow&&O.direction===1&&k!==undefined){var v=k.values;var p=global.positionInArrayByProperty(R,"dimYId",O.fromId);var e=(v[0].y-v[v.length-1].y+v[0].height)/R[p].height;for(var M=0,G=R.length;M<G;M++){var Q=o.values[M];Q.oldY=(H.isStretched)?(p-M)*H.height:(Q.y-R[p].y)*e+v[v.length-1].y||H.height;Q.oldHeight=(H.isStretched)?H.height:Q.height*e||0;Q.startOpacity=(M===p)?1:0}}else{for(var M=0,G=R.length;M<G;M++){var Q=o.values[M];Q.oldY=H.height;Q.oldHeight=0;Q.startOpacity=1}}}}}}P.sort(H.simpleCmp);var I=(O.dim===H.dimYToShow&&O.direction===-1&&k!==undefined)?global.getFromArrayByProperty(J.dimYArray,"id",O.toId):null;var c=(O.dim===H.dimYToShow&&O.direction===1)?global.positionInArrayByProperty(P,"id",O.fromId):null;var n=H.legendWidth/P.length;for(var N=0,m=P.length;N<m;N++){var F=P[N];F.x=N*n;F.width=n;if(O.dim===H.dimXToShow&&O.direction===-1){F.oldX=F.x;F.oldWidth=F.width;F.startOpacity=0}else{if(O.dim===H.dimXToShow&&O.direction===1){F.oldX=F.x;F.oldWidth=F.width;F.startOpacity=0}else{if(O.dim===H.dimYToShow&&O.direction===-1&&k!==undefined){F.oldX=I.x+N*I.width/m;F.oldWidth=I.width/m;F.startOpacity=1}else{if(O.dim===H.dimYToShow&&O.direction===1){F.oldX=(N-c)*H.legendWidth;F.oldWidth=H.legendWidth;F.startOpacity=(N===c)?1:0}else{F.oldX=F.x;F.oldWidth=F.width;F.startOpacity=0}}}}}return{dataArray:u,dimYArray:P}};panel_bar2d.prototype.update=function(e,b){var d=this;d.data=e||d.data;b=b||{dim:-1,direction:0};d.valMultiplier=(isNaN(parseFloat(d.meta.indicators[d.valToShow].fraction.multiplier)))?1:parseFloat(d.meta.indicators[d.valToShow].fraction.multiplier);if(d.valFraction&&d.meta.indicators[d.valToShow].fraction.hide){d.valFraction=false}if(!d.valFraction&&d.meta.indicators[d.valToShow].value.hide){d.valFraction=true}var c=global.getAnimDuration(-1,d.panelId);if(d.data.rows.length>d.maxEntries){d.panic(true,"<html>A panel nem képes "+d.data.rows.length+" értéket megjeleníteni.<br />A maximálisan megjeleníthető értékek száma "+d.maxEntries+".</html>");d.preparedData=undefined}else{d.preparedData=d.prepareData(d.preparedData,d.data.rows,b);var f=Math.max(d.preparedData.dimYArray.length,Math.ceil(d.data.rows.length/d.preparedData.dimYArray.length));if(f>d.maxEntries1D){d.panic(true,"<html>A panel nem képes "+f+" értéket egy dimenzió mentén megjeleníteni.<br />A maximálisan megjeleníthető értékek száma "+d.maxEntries1D+".</html>");d.preparedData=undefined}else{d.panic(false);d.drawAxes(d.preparedData,c);d.drawBars(d.preparedData,c);d.drawLegend(d.preparedData,c)}}var a=d.meta.indicators[d.valToShow];d.titleBox.update(d.valToShow,a.caption,a.value.unit,a.fraction.unit,d.valFraction,c)};panel_bar2d.prototype.drawBars=function(f,d){var c=this;var b=c.gBars.selectAll(".bar").data(f.dataArray,function(g){return g.uniqueId});b.enter().append("svg:g").attr("class","bar bordered darkenable").attr("transform",function(g){return"translate("+g.oldX+", 0)"});b.classed("listener",true).on("click",function(g){c.drill(c.dimX,g)});b.exit().on("click",null).remove();var a=f.dataArray[0].oldWidth;var e=b.selectAll("rect").data(function(g){return g.values},function(g){return g.dimYUniqueId});e.enter().append("svg:rect").attr("x",0).attr("width",a).attr("y",function(g){return g.oldY}).attr("height",function(g){return g.oldHeight}).attr("fill",function(g){return global.color(g.dimYId)}).attr("opacity",function(g){return g.startOpacity});e.exit().remove();b.transition().duration(d).attr("transform",function(g){return"translate("+g.x+", 0)"}).selectAll("rect").attr("y",function(g){return g.y}).attr("height",function(g){return g.height}).attr("width",c.xScale(1-c.barPadding)).attr("opacity",1).each("end",function(){d3.select(this).attr("class",function(g){return"controlled controlled"+g.index})})};panel_bar2d.prototype.drawLegend=function(g,f){var e=this;var a=g.dimYArray;var d=e.gLegend.selectAll(".legendEntry").data(a,function(h){return h.uniqueId});var c=d.enter().insert("svg:g",".bar_group").attr("transform",function(h){return"translate("+(h.oldX+global.legendOffsetX)+", "+(e.h-global.legendHeight-global.legendOffsetY)+")"}).on("click",function(h){e.drill(e.dimY,h)}).on("mouseover",function(){d3.select(this).classed("triggered",true)}).on("mouseout",function(){d3.select(this).classed("triggered",false)});d.attr("class",function(h){return"legendEntry listener legendControl"+h.index});c.append("svg:path").attr("class","legend bordered").attr("d",function(h){return global.rectanglePath(0,0,h.oldWidth,global.legendHeight,0,0,0,0)}).attr("fill",function(h){return global.color(h.id)}).attr("opacity",function(h){return h.startOpacity});c.append("svg:text").attr("class","legend noEvents").attr("x",0).attr("y",global.legendHeight/2).attr("dy","0.35em").attr("fill",function(h){return global.readableColor(global.color(h.id))}).attr("opacity",0).text(function(h){return h.name});d.transition().duration(f).attr("transform",function(h){return"translate("+(h.x+global.legendOffsetX)+", "+(e.h-global.legendHeight-global.legendOffsetY)+")"});d.select("path").transition().duration(f).attr("d",function(j,h){return global.rectanglePath(0,0,j.width,global.legendHeight,(h===0)?global.rectRounding:0,(h===a.length-1)?global.rectRounding:0,(h===a.length-1)?global.rectRounding:0,(h===0)?global.rectRounding:0)}).attr("opacity",1).each("end",function(){d3.select(this).classed("darkenable",true)});d.select("text").text(function(h){return h.name}).transition().duration(f).attr("opacity",1);d.exit().on("click",null).on("mouseover",null).on("mouseout",null).remove();var b=d.selectAll("text");global.cleverCompress(b,e.legendWidth/a.length-0.5*global.legendOffsetX,1,undefined,false,true,e.legendWidth/a.length)};panel_bar2d.prototype.drawAxes=function(g,e){var d=this;var c=global.axisTextSize(d.xScale(1));var a=(c<6)?0:c;if(d.gAxisY.selectAll("path")[0].length>0){d.gAxisY.transition().duration(e).call(d.yAxis)}else{d.gAxisY.call(d.yAxis)}var f=d.gAxisX.selectAll("text").data(g.dataArray,function(h){return h.id+h.name});var b=f.enter().append("svg:text").attr("class","shadowedLabel").attr("font-size",a).attr("opacity",function(h){return(global.valueInRange(h.oldX,0,d.w))?0:global.axisTextOpacity}).attr("transform",function(h){return"rotate(-90)"}).attr("x",-d.height+0.26*a).attr("y",function(h){return h.oldX+h.oldWidth/2+0.35*a}).attr("fill",d.xAxisTextColor).attr("text-anchor","beginning").text(function(h){return h.name});f.exit().transition().duration(e).attr("opacity",0).remove();f.transition().duration(e).attr("font-size",a).attr("x",-d.height+0.26*a).attr("y",function(h){return h.x+h.width/2+0.35*a}).attr("opacity",global.axisTextOpacity);global.cleverCompress(b,d.height,0.95,undefined,true);clearTimeout(d.shadowTimeout);d.gAxisXShadow.selectAll("rect").on("click",null).remove();d.shadowTimeout=setTimeout(function(){d.gAxisXShadow.selectAll("rect").data(g.dataArray,function(h){return h.id+h.name}).enter().append("svg:rect").classed("listener",true).attr("width",c*1.05).attr("height",function(h){return Math.max(30,0.5*c+Math.min(d.gAxisX.selectAll("text").filter(function(i){return h===i})[0][0].getComputedTextLength(),0.7*d.h))}).attr("y",function(h){return d.height-Math.max(30,0.5*c+Math.min(d.gAxisX.selectAll("text").filter(function(i){return h===i})[0][0].getComputedTextLength(),0.7*d.h))}).attr("x",function(h){return h.x+(h.width-c)/2}).attr("opacity",0).on("click",function(h){d.drill(d.dimX,h)})},e)};panel_bar2d.prototype.drill=function(b,c){global.tooltip.kill();var a={dim:(b===this.dimX)?this.dimXToShow:this.dimYToShow,direction:(c===undefined)?1:-1,toId:(c===undefined)?undefined:c.id,toName:(c===undefined)?undefined:c.name};this.mediator.publish("drill",a)};panel_bar2d.prototype.doChangeValue=function(a,d,b){var c=this;if(a===undefined||a===c.panelId){if(d!==undefined){c.valToShow=(d===-1)?(c.valToShow+1)%c.meta.indicators.length:d;c.actualInit.val=c.valToShow}if(b!==undefined){c.valFraction=(b===-1)?!c.valFraction:b;c.actualInit.ratio=c.valFraction}c.update()}};panel_bar2d.prototype.doChangeDimension=function(a,b,d){var c=this;if(a===c.panelId){if(d===0){c.dimXToShow=b;c.actualInit.dimx=c.dimXToShow}else{c.dimYToShow=b;c.actualInit.dimy=c.dimYToShow}c.dimX=(c.dimXToShow<=c.dimYToShow)?0:1;c.dimY=(c.dimXToShow<c.dimYToShow)?1:0;c.mediator.publish("register",c,c.panelId,[c.dimXToShow,c.dimYToShow],c.preUpdate,c.update);global.tooltip.kill();c.mediator.publish("drill",{dim:-1,direction:0,toId:undefined})}};