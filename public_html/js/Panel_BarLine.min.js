"use strict";var barlinepanel=panel_barline;function panel_barline(d){var c=this;this.constructorName="panel_barline";this.defaultInit={group:0,position:undefined,dim:0,valbars:[0],vallines:[],valavglines:[],multiplier:1,ratio:false,streched:false,symbols:false,domain:[],domainr:[],top10:false};this.actualInit=global.combineObjects(c.defaultInit,d);if(c.actualInit.streched){c.actualInit.valavglines=[];c.actualInit.vallines=[]}this.dimToShow=c.actualInit.dim;this.valBarsToShow=c.actualInit.valbars;this.valLinesToShow=c.actualInit.vallines;this.valAvgToShow=c.actualInit.valavglines;this.valFraction=c.actualInit.ratio;this.valBarMultipliers=[];this.valLineMultipliers=[];this.valAvgMultipliers=[];this.isStretched=c.actualInit.streched;this.isSymbolsRequired=c.actualInit.symbols;this.processedData;this.maxEntries=(this.actualInit.top10)?999999999:global.maxEntriesIn1D;this.shadowTimeout;this.buildValueVectors();Panel.call(c,c.actualInit,global.mediators[c.actualInit.group],!c.singleValMode,global.numberOffset,c.avgTextHeight);this.xAxisColor=global.panelBackgroundColor;this.xScale=d3.scale.linear().range([0,c.width]);this.yScale=d3.scale.linear().range([c.height,0]).nice(10);this.yScaleStreched=d3.scale.linear().range([c.height,0]).domain([0,1]);this.xAxis=d3.svg.axis().scale(c.xScale).orient("bottom");this.yAxis=d3.svg.axis().scale(c.yScale).orient("left").ticks(10).tickFormat(global.cleverRound3);if(c.isStretched){c.yAxis.scale(this.yScaleStreched).tickFormat(d3.format("%"))}c.svg.insert("svg:g",".title_group").attr("class","minus background listener droptarget droptarget1").on("mouseover",function(){c.hoverOn(this,"bar")}).on("mouseout",function(){c.hoverOff()}).append("svg:rect").attr("x",c.margin.left).attr("y",(c.isStretched)?c.margin.top:c.margin.top+c.height/2).attr("width",c.width).attr("height",(c.isStretched)?c.height:c.height/2);c.svg.insert("svg:g",".title_group").attr("class","plus background listener droptarget droptarget1").on("mouseover",function(){c.hoverOn(this,"line")}).on("mouseout",function(){c.hoverOff()}).append("svg:rect").attr("x",c.margin.left).attr("y",c.margin.top).attr("width",c.width).attr("height",(c.isStretched)?0:c.height/2);var a=c.svg.insert("svg:g",".title_group").attr("class","background listener droptarget droptarget0").on("click",function(){c.drill()}).on("mouseover",function(){c.hoverOn(this)}).on("mouseout",function(){c.hoverOff()});a.append("svg:rect").attr("width",c.w).attr("height",c.h);if(this.actualInit.top10){a.append("svg:g").attr("class","top_10_holder").attr("transform","matrix(0.4,0,0,0.4,460,64)").html('<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon_top10"></use>')}this.gAxisXShadow=c.svg.insert("svg:g",".title_group").attr("class","axis axisX").attr("transform","translate("+c.margin.left+", "+c.margin.top+")");this.gBars=c.svg.insert("svg:g",".title_group").attr("class","bar_group").attr("transform","translate("+c.margin.left+", "+c.margin.top+")");this.gLines=c.svg.insert("svg:g",".title_group").attr("class","line_group").attr("transform","translate("+c.margin.left+", "+c.margin.top+")");this.gAvgLines=c.svg.insert("svg:g",".title_group").attr("class","avg_group").attr("transform","translate("+c.margin.left+", "+c.margin.top+")");this.gAxisX=c.svg.insert("svg:g",".title_group").attr("class","axis axisX noEvents").attr("transform","translate("+c.margin.left+", "+c.margin.top+")");c.gAxisX.append("svg:line").attr("x1",0).attr("y1",c.height).attr("x2",c.width).attr("y2",c.height);this.gAxisY=c.svg.insert("svg:g",".title_group").attr("class","axis axisY noEvents").attr("transform","translate("+c.margin.left+", "+c.margin.top+")");var b;b=c.mediator.subscribe("changeValue",function(h,g,e,f){c.doChangeValue(h,g,e,f)});c.mediatorIds.push({channel:"changeValue",id:b.id});b=c.mediator.subscribe("changeDimension",function(e,f,g){c.doChangeDimension(e,f)});c.mediatorIds.push({channel:"changeDimension",id:b.id});c.mediator.publish("register",c,c.panelId,[c.dimToShow],c.preUpdate,c.update,c.getConfig)}panel_barline.prototype=global.subclassOf(Panel);panel_barline.prototype.barPadding=0.1;panel_barline.prototype.avgTextHeight=16;panel_barline.prototype.avgText="Átlag";panel_barline.prototype.symbolSize=128;panel_barline.prototype.symbolSize_background=140;panel_barline.prototype.lineBarGenerator=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y});panel_barline.prototype.oldLineBarGenerator=d3.svg.line().x(function(a){return a.oldX}).y(function(a){return a.oldY});panel_barline.prototype.barValuesToShow=function(g){var e=[];if(g!==undefined&&g.vals!==undefined){var b=0;for(var c=0,a=this.valBarNumber;c<a;c++){var f=(this.valFraction)?this.valBarMultipliers[c]*g.vals[this.valBarsToShow[c]].sz/g.vals[this.valBarsToShow[c]].n:g.vals[this.valBarsToShow[c]].sz;if(isNaN(parseInt(f))){f=0}e.push({value:f,accumulation:b});b+=f}}return e};panel_barline.prototype.lineValuesToShow=function(e){var b=[];if(e!==undefined&&e.vals!==undefined){for(var a=0;a<this.valLineNumber;a++){var c=(this.valFraction)?this.valLineMultipliers[a]*e.vals[this.valLinesToShow[a]].sz/e.vals[this.valLinesToShow[a]].n:e.vals[this.valLinesToShow[a]].sz;if(isNaN(parseInt(c))){c=0}b[a]=c}}else{for(var a=0;a<this.valLineNumber;a++){b[a]=0}}return b};panel_barline.prototype.sumValueToShow=function(f){var e=0;var g=this.lineValuesToShow(f);var b=this.barValuesToShow(f);for(var c=0,a=g.length;c<a;c++){e=e+Math.abs(g[c])}for(var c=0,a=b.length;c<a;c++){e=e+Math.abs(b[c].value)}return e};panel_barline.prototype.avgLineValuesToShow=function(a){var k=[];for(var h=0;h<this.valAvgNumber;h++){var j=0;var c=0;for(var f=0,e=a.length;f<e;f++){var g=a[f];if(g!==undefined&&g.vals!==undefined){j+=g.vals[this.valAvgToShow[h]].sz;c+=g.vals[this.valAvgToShow[h]].n}}var b=(this.valFraction)?this.valAvgMultipliers[h]*j/c:j/a.length;if(isNaN(parseInt(b))){b=0}k.push({value:b})}return k};panel_barline.prototype.getTooltip=function(g){var c=this;var f=[];for(var b=0;b<c.legendArray.length;b++){var a=c.legendArray[b];var j=a.id;var e=undefined,h=undefined;if(a.isBarRequired){e=g.barValues[global.positionInArray(c.valBarsToShow,j)].value}else{if(a.isLineRequired){e=g.lineValues[global.positionInArray(c.valLinesToShow,j)]}}if(a.isAvgRequired){h=g.avgValues[global.positionInArray(c.valAvgToShow,j)].value}f.push({name:c.meta.indicators[j].description,value:e,dimension:(c.valFraction)?c.meta.indicators[j].fraction.unit:c.meta.indicators[j].value.unit,avgValue:h})}return c.createTooltip([{name:c.meta.dimensions[c.dimToShow].description,value:(g.name)?g.name:"Nincs adat"}],f)};panel_barline.prototype.horizontalLine=function(b,a,c){return"M"+b+","+c+"L"+a+","+c};panel_barline.prototype.veeLine=function(a,d){var c=this;var b=global.positionInArrayByProperty(a,"id",d);return"M"+c.interpolate("x",a[b-1],a[b],a[b+1],0,2)+","+c.interpolate("y",a[b-1],a[b],a[b+1],0,2)+"L"+c.interpolate("x",a[b-1],a[b],a[b+1],1,2)+","+c.interpolate("y",a[b-1],a[b],a[b+1],1,2)+"L"+c.interpolate("x",a[b-1],a[b],a[b+1],2,2)+","+c.interpolate("y",a[b-1],a[b],a[b+1],2,2)};panel_barline.prototype.extrapolate=function(c,b,a){return b[c]+(b[c]-a[c])/2};panel_barline.prototype.interpolate=function(h,n,l,k,g,f){if(n===null||l===null||k===null||g===null||f===null||isNaN(n)||isNaN(l)||isNaN(k)||isNaN(g)){return 1000}var j=l[h];var d=(n.isFake)?2*n[h]-j:n[h];var e=(k.isFake)?2*k[h]-j:k[h];var m=(g/f)-0.5;if(m<0){m=-m;e=d}return m*e+(1-m)*j};panel_barline.prototype.setYScale=function(b){var a=(this.valFraction)?this.actualInit.domainr:this.actualInit.domain;if((a instanceof Array)&&a.length===2){this.yScale.domain(a)}else{this.yScale.domain(b)}if(!this.isStretched){this.yScale.nice(10)}};panel_barline.prototype.preUpdate=function(d){var f=this;var b=f.processedData;if(d.direction===-1){f.gAxisX.selectAll("text").filter(function(j){return(j.id!==d.toId)}).remove();f.gAxisXShadow.selectAll("rect").on("click",null).remove();f.gBars.selectAll(".bar").filter(function(j){return(j.id!==d.toId)}).on("click",null).remove();f.gBars.selectAll(".bar").each(function(l){var k=l.x-f.barPadding*l.width/2;var j=l.x+l.width+f.barPadding*l.width/2;f.gAvgLines.selectAll("path").attr("d",function(m){return f.horizontalLine(k,j,m.y)})});f.gAvgLines.selectAll("text").remove();f.gLines.selectAll(".lineChart").attr("d",function(j){return f.veeLine(j,d.toId)});f.gLines.selectAll(".lineSymbolHolder").on("click",null).remove()}else{if(d.direction===1){f.gAxisX.selectAll("text").filter(function(j){return(j.id!==d.fromId)}).remove();f.gAxisXShadow.selectAll("rect").on("click",null).remove();var g=[];for(var e=0,c=f.valBarNumber;e<c;e++){var h=d3.mean(b.dataArray,function(j){return j.barValues[e].height});var i=d3.mean(b.dataArray,function(j){return j.barValues[e].y});g.push({height:h,y:i})}f.gBars.selectAll(".bar").on("click",null).remove();var a=(global.baseLevels[f.panelSide])[f.dimToShow].length;f.gBars.selectAll(".bar").data([{id:d.fromId,uniqueId:a+"L"+d.fromId}]).enter().append("svg:g").attr("class","bar bordered darkenable").attr("transform","translate("+(f.xScale.range()[1]*(f.barPadding/2))+", 0)").attr("opacity",1).selectAll("rect").data(g).enter().append("svg:rect").attr("class",function(k,j){return"controlled controlled"+f.valBarsToShow[j]}).attr("x",0).attr("width",f.xScale.range()[1]*(1-f.barPadding)).attr("y",function(j){return j.y}).attr("height",function(j){return j.height}).attr("fill",function(k,j){return global.colorValue(f.valBarsToShow[j])});f.gAvgLines.selectAll("path").attr("d",function(j){return f.horizontalLine(-f.margin.left,f.width+f.margin.right,j.y)});f.gAvgLines.selectAll("text").remove();f.gLines.selectAll(".lineChart").attr("d",function(k){var j=d3.mean(k,function(l){return(l.id<-10)?undefined:l.y});return f.horizontalLine(-f.margin.left,f.width+f.margin.right,j)});f.gLines.selectAll(".lineSymbolHolder").on("click",null).remove()}}};panel_barline.prototype.getTop10=function(c){for(var b=0,a=c.length;b<a;b++){c[b].sumVal=this.sumValueToShow(c[b])}c.sort(function(e,d){return d.sumVal-e.sumVal});return c.slice(0,10)};panel_barline.prototype.prepareData=function(F,p,M){var D=this;var f=(global.baseLevels[D.panelSide])[D.dimToShow].length;var s=[];if(D.actualInit.top10){p=D.getTop10(p)}else{p.sort(D.cmp)}D.xScale.domain([0,p.length]);var N=(M.direction===-1&&F)?global.getFromArrayByProperty(F.dataArray,"id",M.toId):null;N=N||null;var u;if(M.direction===1){for(var L=0,k=p.length;L<k;L++){if(p[L].dims[0].id===M.fromId){u=L;break}}}var h=D.avgLineValuesToShow(p);var O=d3.max(h,function(i){return i.value})||0;var n=d3.min(h,function(i){return i.value})||0;var B=0;var x=0;var a=0;var S=0;for(var L=0,k=p.length;L<k;L++){var r=p[L];var l={};l.index=L;l.id=r.dims[0].id;l.uniqueId=f+"L"+l.id;l.name=r.dims[0].name.trim();l.barValues=D.barValuesToShow(r);l.lineValues=D.lineValuesToShow(r);l.avgValues=h;l.sumBarValues=(D.valBarNumber>0)?l.barValues[D.valBarNumber-1].value+l.barValues[D.valBarNumber-1].accumulation:0;B=Math.max(B,l.sumBarValues||0);x=Math.max(x,d3.max(l.lineValues)||0);a=Math.min(a,l.sumBarValues||0);S=Math.min(S,d3.min(l.lineValues)||0);l.tooltip=D.getTooltip(l);s.push(l)}var J=D.xScale.range()[1];var q=J*(1-D.barPadding);var y=Math.max(B,x,O);var b=Math.min(a,S,n,0);var o=D.yScale.domain()[1];var I=D.yScale.domain()[0];D.setYScale([b,y]);var v=(D.isStretched)?1:(D.yScale.domain()[1]-D.yScale.domain()[0])/(o-I);var c=d3.scale.linear().domain([b,y]).range([b,y]);var H=D.xScale(1-D.barPadding);var t=(N)?N.x:0;for(var L=0,k=s.length;L<k;L++){l=s[L];if(D.isStretched){c.domain([0,l.sumBarValues])}l.x=D.xScale(L+D.barPadding/2);l.width=H;for(var K=0,C=D.valBarNumber;K<C;K++){var R=l.barValues[K];R.height=D.yScale(c(0))-D.yScale(c(Math.abs(R.value)));R.y=(R.value>=0)?D.yScale(c(R.value+R.accumulation)):D.yScale(c(R.accumulation));R.tooltip=l.tooltip}if(M.direction===-1&&N){l.oldX=t||0;l.oldWidth=(N.width/k)||0;t=t+l.oldWidth;for(var K=0,C=D.valBarNumber;K<C;K++){l.barValues[K].oldHeight=N.barValues[K].height||0;l.barValues[K].oldY=N.barValues[K].y||0}}else{if(M.direction===1){l.oldX=(L-u+D.barPadding/2)*J||0;l.oldWidth=q||0;for(var K=0,C=D.valBarNumber;K<C;K++){var G=l.barValues[K]||0;G.oldHeight=global.orZero(v*G.height)||0;G.oldY=global.orZero(D.height*(1-v)+v*G.y)||0}}else{l.oldX=l.x||0;l.oldWidth=l.width||0;for(var K=0,C=D.valBarNumber;K<C;K++){var G=l.barValues[K]||0;G.oldHeight=0||0;G.oldY=D.yScale(0)||0}}}}for(var K=0,C=D.valAvgNumber;K<C;K++){var m=h[K];m.id=D.valAvgToShow[K];m.y=D.yScale(h[K].value);m.x0=1;m.x1=D.width+D.avgTextHeight;if(M.direction===-1&&F){m.oldY=F.avgValues[K].y||0;m.oldX0=(N.x-(N.width*D.barPadding/2))||0;m.oldX1=(N.x+(N.width*(1+D.barPadding/2)))||0}else{if(M.direction===1&&F){m.oldY=F.avgValues[K].y||0;m.oldX0=((-u+D.barPadding/2)*J)||0;m.oldX1=((s.length-u+D.barPadding/2)*J)||0}else{m.oldY=(F)?(F.avgValues[K].y||0):(D.height||0);m.oldX0=1;m.oldX1=D.width+D.avgTextHeight}}}var E=(M.direction===-1&&N)?N.index+1:undefined;var w=[];for(var K=0,C=D.valLineNumber;K<C;K++){var z=(F)?F.lineArray[K]:undefined;var A=(F)?d3.mean(z,function(i){return(i.id<-10)?undefined:i.y}):D.heiht;var g=[];g.push({id:-99,isFake:true});for(var L=0,k=s.length;L<k;L++){var Q={};Q.id=s[L].id;Q.uniqueId=s[L].uniqueId;Q.name=s[L].name.trim();Q.value=s[L].lineValues[K];Q.x=D.xScale(L+0.5);Q.y=D.yScale(Q.value);Q.tooltip=s[L].tooltip;g.push(Q)}var k=s.length;g.push({id:-999,isFake:true});g[0].x=(k>1)?D.extrapolate("x",g[1],g[2]):0;g[0].y=(k>1)?D.extrapolate("y",g[1],g[2]):g[1].y;g[k+1].x=(k>1)?D.extrapolate("x",g[k],g[k-1]):D.width;g[k+1].y=(k>1)?D.extrapolate("y",g[k],g[k-1]):g[k-1].y;for(var L=0,k=g.length;L<k;L++){if(M.direction===-1&&E){g[L].oldX=D.interpolate("x",z[E-1],z[E],z[E+1],L,k-1)||0;g[L].oldY=D.interpolate("y",z[E-1],z[E],z[E+1],L,k-1)||0}else{if(M.direction===1){g[L].oldX=((L-0.5-u)*J)||0;g[L].oldY=A||0}else{if(z){var P=g[L].id;var e=global.getFromArrayByProperty(z,"id",P)||0;g[L].oldX=((e)?e.x:D.xScale(L-0.5))||0;g[L].oldY=((e)?e.y:D.height)||0}else{g[L].oldX=((L===0)?0:(L===k-1)?D.width:D.xScale(L-0.5))||0;g[L].oldY=D.height||0}}}}w.push(g)}return{avgValues:h,dataArray:s,lineArray:w}};panel_barline.prototype.update=function(m,c,g){var o=this;o.data=m||o.data;c=c||{dim:-1,direction:0};var p=false;var e=false;for(var n=0,k=o.legendArray.length;n<k;n++){if(o.meta.indicators[o.legendArray[n].id].value.hide){e=true;o.valFraction=true}if(o.meta.indicators[o.legendArray[n].id].fraction.hide){p=true;o.valFraction=false}}if(o.data.rows.length>o.maxEntries){o.panic(true,"<html>A panel nem képes "+o.data.rows.length+" értéket megjeleníteni.<br />A maximálisan megjeleníthető értékek száma "+o.maxEntries+".</html>");o.processedData=undefined}else{if(p&&e){o.panic(true,"<html>Az ellentétes megjelenítési utasítások miatt<br />az adatok nem megjeleníthetőek.</html>");o.processedData=undefined}else{o.panic(false);o.valBarMultipliers=[];for(var n=0,k=o.valBarNumber;n<k;n++){var j=parseFloat(o.meta.indicators[o.valBarsToShow[n]].fraction.multiplier);o.valBarMultipliers.push((isNaN(j))?1:j)}o.valLineMultipliers=[];for(var n=0,k=o.valLineNumber;n<k;n++){var j=parseFloat(o.meta.indicators[o.valLinesToShow[n]].fraction.multiplier);o.valLineMultipliers.push((isNaN(j))?1:j)}o.valAvgMultipliers=[];for(var n=0,k=o.valAvgNumber;n<k;n++){var j=parseFloat(o.meta.indicators[o.valAvgToShow[n]].fraction.multiplier);o.valAvgMultipliers.push((isNaN(j))?1:j)}var l=(g===undefined)?global.getAnimDuration(-1,o.panelId):g;o.processedData=o.prepareData(o.processedData,o.data.rows,c);o.drawAxes(o.processedData,l);o.drawBars(o.processedData,l);o.drawLines(o.processedData,l,(c.dim!==-1));o.drawAvgLines(o.processedData,l)}}if(o.singleValMode){var a=o.meta.indicators[o.legendArray[0].id];o.titleBox.update(o.legendArray[0].id,a.caption,a.value.unit,a.fraction.unit,o.valFraction,l)}else{if(c.toId===undefined||c.dim===-1){var h=o.meta.indicators;var f=[],q=[],r=[],d=[];for(var n=0,k=o.legendArray.length;n<k;n++){var b=o.legendArray[n].id;f.push(b);q.push(h[b].caption);r.push(h[b].value.unit);d.push(h[b].fraction.unit)}o.titleBox.update(f,q,r,d,o.valFraction,l);o.drawLegend()}}};panel_barline.prototype.drawBars=function(f,e){var d=this;if(d.valBarNumber>0){var b=d.gBars.selectAll(".bar").data(f.dataArray,function(g){return g.uniqueId});b.selectAll("rect").data(function(g){return g.barValues});var c=b.enter().append("svg:g").attr("class","bar bordered").attr("transform",function(g){return"translate("+g.oldX+", 0)"}).attr("opacity",function(g){return(global.valueInRange(g.oldX+g.oldWidth/2,0,d.w))?1:0});var a=f.dataArray[0].oldWidth;c.selectAll("rect").data(function(g){return g.barValues}).enter().append("svg:rect").attr("x",0).attr("width",a).attr("y",function(g){return g.oldY}).attr("height",function(g){return g.oldHeight}).attr("fill",function(h,g){return global.colorValue(d.valBarsToShow[g])});b.classed("listener",true).on("click",function(g){d.drill(g)});b.transition().duration(e).attr("transform",function(g){return"translate("+g.x+", 0)"}).attr("opacity",1).each("end",function(){d3.select(this).classed("darkenable",true)}).selectAll("rect").attr("class",function(h,g){return"controlled controlled"+d.valBarsToShow[g]}).attr("y",function(g){return g.y}).attr("height",function(g){return g.height}).attr("width",d.xScale(1-d.barPadding)).attr("fill",function(h,g){return global.colorValue(d.valBarsToShow[g])});b.exit().on("click",null).remove()}};panel_barline.prototype.drawLines=function(h,d,g){var c=this;if(c.valLineNumber>0){if(g){c.gLines.selectAll(".lineChart").remove()}var b=this.gLines.selectAll(".lineChart").data(h.lineArray);b.enter().insert("svg:path",".lineSymbolGroup").attr("d",c.oldLineBarGenerator).attr("stroke",function(k,j){return global.colorValue(c.valLinesToShow[j])});b.transition().duration(d).attr("class",function(k,j){return"noEvents lineChart controlled controlled"+c.valLinesToShow[j]}).attr("d",c.lineBarGenerator).attr("stroke",function(k,j){return global.colorValue(c.valLinesToShow[j])});var f=this.gLines.selectAll(".lineSymbolGroup").data(h.lineArray);f.enter().append("svg:g");f.attr("class",function(k,j){return"lineSymbolGroup controlled controlled"+c.valLinesToShow[j]});var a=f.selectAll(".lineSymbolHolder").data(function(i){return i},function(i){return i.uniqueId+"s"+c.valLinesToShow[0]});a.select(".shadow").attr("d",function(m,l,k){return d3.svg.symbol().type(d3.svg.symbolTypes[(c.valLinesToShow[k])%6]).size(c.symbolSize_background)()});a.select(".lineSymbol:not(.shadow)").attr("d",function(m,l,k){return d3.svg.symbol().type(d3.svg.symbolTypes[(c.valLinesToShow[k])%6]).size(c.symbolSize)()}).transition().duration(d).attr("fill",function(m,l,k){return global.colorValue(c.valLinesToShow[k])});var e=a.enter().append("svg:g").attr("class","lineSymbolHolder listener").attr("transform",function(i){return"translate("+i.oldX+","+i.oldY+")"}).on("click",function(i){if(!i.isFake){c.drill(i)}});e.append("svg:path").attr("class","lineSymbol shadow").attr("d",function(m,l,k){return d3.svg.symbol().type(d3.svg.symbolTypes[(c.valLinesToShow[k])%6]).size(c.symbolSize_background)()});e.append("svg:path").attr("class","lineSymbol").attr("d",function(m,l,k){return d3.svg.symbol().type(d3.svg.symbolTypes[(c.valLinesToShow[k])%6]).size(c.symbolSize)()}).attr("fill",function(m,l,k){return global.colorValue(c.valLinesToShow[k])});a.exit().classed("darkenable",false).on("click",null).transition().duration(d).attr("opacity",0).attr("transform",function(i){return"translate("+i.x+","+c.height+")"}).remove();a.transition().duration(d).attr("opacity",function(i){return(!i.isFake&&c.isSymbolsRequired)?1:0}).attr("transform",function(i){return"translate("+i.x+","+i.y+")"}).each("end",function(i){d3.select(this).select(".lineSymbol:not(.shadow)").classed("darkenable",!i.isFake)})}};panel_barline.prototype.drawAvgLines=function(e,d){var c=this;if(c.valAvgNumber>0&&!c.isStretched){var b=this.gAvgLines.selectAll("path").data(e.avgValues,function(f){return f.uniqueId});b.enter().append("svg:path").attr("opacity",0);b.exit().remove();b.attr("d",function(f){return c.horizontalLine(f.oldX0,f.oldX1,f.oldY)}).attr("class",function(g,f){return"noEvents lineChart controlled controlled"+c.valAvgToShow[f]}).transition().duration(d).attr("stroke",function(g,f){return d3.rgb(global.colorValue(c.valAvgToShow[f])).darker(2)}).attr("d",function(f){return c.horizontalLine(f.x0,f.x1,f.y)}).attr("opacity",1);var a=this.gAvgLines.selectAll("text").data(e.avgValues,function(f){return f.id});a.enter().append("svg:text").attr("class",function(g,f){return"noEvents controlled controlled"+c.valAvgToShow[f]}).attr("text-anchor","begin").attr("x",function(f){return f.oldX1+c.avgTextHeight}).attr("y",function(f){return f.oldY}).attr("dy","-.25em").attr("dx",".35em").attr("opacity",0).attr("transform",function(f){return"rotate(-90,"+(f.oldX1+c.avgTextHeight)+","+f.oldY+")"}).text(c.avgText);a.exit().remove();a.transition().duration(d).attr("x",c.width+c.avgTextHeight).attr("y",function(f){return f.y}).attr("opacity",1).attr("stroke",function(g,f){return d3.rgb(global.colorValue(c.valAvgToShow[f])).darker(2)}).attr("transform",function(f){return"rotate(-90,"+(c.width+c.avgTextHeight)+","+f.y+")"})}else{this.gAvgLines.selectAll("*").remove()}};panel_barline.prototype.drawLegend=function(){var b=this;if(b.gLegend.selectAll(".legend").empty()){var c=b.legendWidth/b.legendArray.length;var f=global.legendHeight;var e=b.gLegend.selectAll("g.lineLegend").data(b.legendArray).enter();var d=e.insert("svg:g",".bar_group").attr("class",function(h,g){return"listener droptarget droptarget1 legend legendControl"+h.id}).attr("transform",function(h,g){return"translate("+(g*c+global.legendOffsetX*1.5)+", "+(b.h-f-global.legendOffsetY)+")"}).on("mouseover",function(g){if(global.dragDropManager.draggedType===null){d3.select(this).classed("triggered",true)}else{b.hoverOn(this,g.id)}}).on("mouseout",function(){if(global.dragDropManager.draggedType===null){d3.select(this).classed("triggered",false)}else{b.hoverOff()}}).on("click",function(g){b.toggleAvg(g.id)});d.append("svg:rect").attr("class",function(g){return(!g.isLineRequired&&!g.isAvgRequired)?"bordered ":"lineChartLegend "}).attr("rx",global.rectRounding).attr("ry",global.rectRounding).attr("width",c-global.legendOffsetX).attr("height",f).attr("fill",function(g){return global.colorValue(g.id)}).attr("fill-opacity",function(g){return(g.isBarRequired)?1:0}).attr("stroke",function(g){return global.colorValue(g.id)}).attr("stroke-opacity",function(g){return(g.isLineRequired)?1:0});d.append("svg:rect").select(function(g){return(g.isAvgRequired)?this:null}).attr("class",function(g){return"lineChartLegend legend noEvents"}).attr("rx",global.rectRounding).attr("ry",global.rectRounding).attr("width",c-global.legendOffsetX).attr("height",f).attr("fill","none").attr("stroke",function(g){return d3.rgb(global.colorValue(g.id)).darker(2)}).attr("stroke-dasharray",function(g){return(g.isLineRequired)?10:"none"});if(b.isSymbolsRequired){d.append("svg:path").select(function(g){return(g.isLineRequired)?this:null}).attr("class","lineSymbol legend shadow noEvents").attr("d",function(g){return d3.svg.symbol().type(d3.svg.symbolTypes[g.id%6]).size(b.symbolSize_background)()}).attr("transform",function(h,g){return"translate("+(global.rectRounding/2)+", 0)"});d.append("svg:path").select(function(g){return(g.isLineRequired)?this:null}).attr("class","lineSymbol legend noEvents").attr("d",function(g){return d3.svg.symbol().type(d3.svg.symbolTypes[g.id%6]).size(b.symbolSize)()}).attr("fill",function(g){return global.colorValue(g.id)}).attr("transform",function(h,g){return"translate("+(global.rectRounding/2)+", 0)"})}var a=d.append("svg:text").attr("class","legend noEvents").attr("y",global.legendHeight/2).attr("dy",".35em").attr("fill",function(g){return global.readableColor((g.isBarRequired)?global.colorValue(g.id):global.panelBackgroundColor)}).text(function(h,g){return b.meta.indicators[b.legendArray[g].id].caption});global.cleverCompress(a,c-1.8*global.legendOffsetX,1,undefined,false,true,c-global.legendOffsetX)}};panel_barline.prototype.drawAxes=function(g,e){var d=this;var c=global.axisTextSize(d.xScale(1));var a=(c<6)?0:c;if(d.gAxisY.selectAll("path")[0].length>0){d.gAxisY.transition().duration(e).call(d.yAxis)}else{d.gAxisY.call(d.yAxis)}d.gAxisX.select("line").transition().duration(e).attr({x1:0,y1:d.yScale(0),x2:d.width,y2:d.yScale(0)});var f=d.gAxisX.selectAll("text").data(g.dataArray,function(h){return h.id+h.name});var b=f.enter().append("svg:text").attr("class","shadowedLabel").attr("font-size",a).attr("opacity",function(h){return(global.valueInRange(h.oldX+h.oldWidth/2,0,d.w))?0:global.axisTextOpacity}).attr("transform",function(h){return"rotate(-90)"}).attr("x",-d.height+0.26*a).attr("y",function(h){return h.oldX+h.oldWidth/2+0.35*a}).attr("fill",d.xAxisColor).attr("text-anchor","beginning").text(function(h){return h.name});f.exit().transition().duration(e).attr("opacity",0).remove();f.transition().duration(e).attr("font-size",a).attr("x",-d.height+0.26*a).attr("y",function(h){return h.x+h.width/2+0.35*a}).attr("opacity",global.axisTextOpacity);global.cleverCompress(b,d.height,0.95,undefined,true);clearTimeout(d.shadowTimeout);d.gAxisXShadow.selectAll("rect").on("click",null).remove();d.shadowTimeout=setTimeout(function(){d.gAxisXShadow.selectAll("rect").data(g.dataArray,function(h){return h.id+h.name}).enter().append("svg:rect").classed("listener",true).attr("width",c*1.05).attr("height",function(h){return Math.max(50,0.5*c+Math.min(d.gAxisX.selectAll("text").filter(function(i){return h===i})[0][0].getComputedTextLength(),0.7*d.h))}).attr("y",function(h){return d.height-Math.max(50,0.5*c+Math.min(d.gAxisX.selectAll("text").filter(function(i){return h===i})[0][0].getComputedTextLength(),0.7*d.h))}).attr("x",function(h){return h.x+(h.width-c)/2}).attr("opacity",0).on("click",function(h){d.drill(h)})},e)};panel_barline.prototype.buildValueVectors=function(){var a=this;if(a.isStretched){a.valLinesToShow.length=0;a.valAvgToShow.length=0}a.valBarsToShow=a.valBarsToShow.filter(function(b,c){return a.valBarsToShow.indexOf(b)===c});a.valLinesToShow=a.valLinesToShow.filter(function(b,c){return a.valLinesToShow.indexOf(b)===c});a.valAvgToShow=a.valAvgToShow.filter(function(b,c){return a.valAvgToShow.indexOf(b)===c});a.valLinesToShow=a.valLinesToShow.filter(function(b){return a.valBarsToShow.indexOf(b)===-1});a.valAvgToShow=a.valAvgToShow.filter(function(b){return(a.valLinesToShow.indexOf(b)!==-1||a.valBarsToShow.indexOf(b)!==-1)});a.valBarNumber=a.valBarsToShow.length;a.valLineNumber=a.valLinesToShow.length;a.valAvgNumber=a.valAvgToShow.length;a.legendArray=a.createLegendArray();a.singleValMode=(a.legendArray.length===1)};panel_barline.prototype.createLegendArray=function(){var f=this;var b=d3.max([d3.max(f.valBarsToShow),d3.max(f.valLinesToShow),d3.max(f.valAvgToShow)]);var d=[];for(var e=0,a=b+1;e<a;e++){d.push({id:e})}for(var e=0,a=f.valBarNumber;e<a;e++){d[f.valBarsToShow[e]].isBarRequired=true}for(var e=0,a=f.valAvgNumber;e<a;e++){d[f.valAvgToShow[e]].isAvgRequired=true}for(var e=0,a=f.valLineNumber;e<a;e++){d[f.valLinesToShow[e]].isLineRequired=true}var c=[];for(var e=0,a=b+1;e<a;e++){if(d[e].isBarRequired||d[e].isAvgRequired||d[e].isLineRequired){c.push(d[e])}}return c};panel_barline.prototype.drill=function(b){global.tooltip.kill();var a={dim:this.dimToShow,direction:(b===undefined)?1:-1,toId:(b===undefined)?undefined:b.id,toName:(b===undefined)?undefined:b.name};this.mediator.publish("drill",a)};panel_barline.prototype.toggleAvg=function(b){var a=global.positionInArray(this.valAvgToShow,b);if(a===-1){this.valAvgToShow.push(b)}else{this.valAvgToShow.splice(a,1)}this.buildValueVectors();this.processedData=undefined;this.gLegend.selectAll(".legend").remove();this.update(undefined,undefined,0)};panel_barline.prototype.doChangeValue=function(c,k,i,l){var g=this;if(c===undefined||c===g.panelId){if(i!==undefined){g.valFraction=(i===-1)?!g.valFraction:i;if(k!==undefined&&g.singleValMode){if(g.valBarNumber===1){g.valBarsToShow[0]=k}if(g.valLineNumber===1){g.valLinesToShow[0]=k}if(g.valAvgNumber===1){g.valAvgToShow[0]=k}g.buildValueVectors()}}else{var j=g.valBarNumber;var b=g.valLineNumber;var e=g.valAvgNumber;var h=false;if(k===-1&&g.singleValMode){h=true;var a=(g.legendArray[0].id+1)%g.meta.indicators.length;if(g.valBarNumber===1){g.valBarsToShow[0]=a}if(g.valLineNumber===1){g.valLinesToShow[0]=a}if(g.valAvgNumber===1){g.valAvgToShow[0]=a}}if(k>-1&&(l==="bar"||l==="line")){h=true;if(l==="bar"){g.valBarsToShow.push(k)}else{g.valLinesToShow.push(k);var f=g.valBarsToShow.indexOf(k);if(f!==-1){g.valBarsToShow.splice(f,1)}}}if(l===undefined){h=true;if(g.valBarNumber<g.valLineNumber){g.valLinesToShow[0]=k;g.valLinesToShow.length=1;g.valBarsToShow.length=0;g.valAvgToShow.length=0}else{g.valBarsToShow[0]=k;g.valBarsToShow.length=1;g.valLinesToShow.length=0;g.valAvgToShow.length=0}if(g.valAvgNumber>0){g.valAvgToShow[0]=k;g.valAvgToShow.length=1}}if(!isNaN(k)&&!isNaN(l)){h=true;var d=global.positionInArray(g.valBarsToShow,l);if(d!==-1){g.valBarsToShow[d]=k}var d=global.positionInArray(g.valLinesToShow,l);if(d!==-1){g.valLinesToShow[d]=k}var d=global.positionInArray(g.valAvgToShow,l);if(d!==-1){g.valAvgToShow[d]=k}g.gLegend.selectAll(".legend").remove()}if(h){g.buildValueVectors();g.changeConfiguration(!g.singleValMode,global.numberOffset,g.avgTextHeight,0,0);g.processedData=undefined;if(j!==this.valBarNumber){g.gBars.selectAll("*").remove()}if(b!==this.valLineNumber){g.gLines.selectAll("*").remove()}if(e!==this.valAvgNumber){g.gAvgLines.selectAll("*").remove()}g.gLegend.selectAll(".legend").remove();g.svg.selectAll(".hoveredDropTarget").remove()}}g.actualInit.valbars=g.valBarsToShow;g.actualInit.vallines=g.valLinesToShow;g.actualInit.valavglines=g.valAvgToShow;g.actualInit.ratio=g.valFraction;g.update()}};panel_barline.prototype.doChangeDimension=function(a,b){var c=this;if(a===c.panelId){c.dimToShow=b;c.actualInit.dim=c.dimToShow;c.mediator.publish("register",c,c.panelId,[c.dimToShow],c.preUpdate,c.update);global.tooltip.kill();this.mediator.publish("drill",{dim:-1,direction:0,toId:undefined})}};panel_barline.prototype.changeConfiguration=function(e,c,d,a,b){if(this.isLegendRequired!==e){this.isLegendRequired=e;this.margin={top:global.panelTitleHeight+3*global.legendOffsetY+a,right:global.legendOffsetX+d,bottom:b+((e)?global.legendHeight+2*global.legendOffsetY:global.legendOffsetY+global.legendHeight/2),left:global.legendOffsetX+c};this.width=this.w-this.margin.left-this.margin.right;this.height=this.h-this.margin.top-this.margin.bottom;this.yScale.range([this.height,0]);this.yScaleStreched.range([this.height,0]);this.gAxisX.select("line").attr({x1:0,y1:this.height,x2:this.width,y2:this.height});this.gAxisX.selectAll("text").remove();this.gAxisXShadow.selectAll("text").on("click",null).remove();this.svg.select(".background.minus rect").attr("y",(this.isStretched)?this.margin.top:this.margin.top+this.height/2).attr("height",(this.isStretched)?this.height:this.height/2);this.svg.select(".background.plus rect").attr("height",(this.isStretched)?0:this.height/2)}};